<html>
    <head>
        <title></title>


        <script id="vertex-shader" type="x-shader/x-vertex">
            attribute vec4 vPosition;
            attribute float vPointSize;
            uniform float u_pointsize;

            attribute vec4 vColor;
            varying vec4 fColor;

            attribute float vAtlasId;
            varying float fAtlasId;

            attribute vec4 layer0_vPosition;
            attribute vec4 layer1_vPosition;
            attribute vec4 layer2_vPosition;
            attribute vec4 layer3_vPosition;
            attribute vec4 layer4_vPosition;

            attribute vec4 layer0_vColor;
            attribute vec4 layer1_vColor;
            attribute vec4 layer2_vColor;
            attribute vec4 layer3_vColor;
            attribute vec4 layer4_vColor;

            attribute float layer0_vPointSize;
            attribute float layer1_vPointSize;
            attribute float layer2_vPointSize;
            attribute float layer3_vPointSize;
            attribute float layer4_vPointSize;

            attribute float layer0_vAtlasId;
            attribute float layer1_vAtlasId;
            attribute float layer2_vAtlasId;
            attribute float layer3_vAtlasId;
            attribute float layer4_vAtlasId;


            float getWebGLCoordinate(float value, float side, bool invert){
                float direction = invert ? -1.0 : 1.0;
                float p = value / side;
                return ((p * 2.0) - 1.0) * direction;
            }

            vec4 calculateLayers(){
                vec4 res;

                res = layer0_vColor + layer1_vColor + layer2_vColor + layer3_vColor + layer4_vColor;

                return res;
            }

            void main() {
                float usedLayers = 2.;
                //fColor = vColor;
                fColor = calculateLayers();
                //fAtlasId = vAtlasId;
                fAtlasId = layer0_vAtlasId;

                //gl_Position = uRotation * vPosition;

                /*float x = getWebGLCoordinate(vPosition.x, 800.0, false);
                float y = getWebGLCoordinate(vPosition.y, 800.0, true);
                vec4 newPosition = vec4(x, y, 0, 1);
                gl_Position = newPosition;*/
                //gl_Position = vPosition;
                gl_Position = layer0_vPosition;

                //gl_PointSize = u_pointsize;
                //gl_PointSize = vColor.r * u_pointsize; // cool!
                //gl_PointSize = vPointSize;
                gl_PointSize = layer0_vPointSize;
            }
        </script>
        <script id="fragment-shader" type="x-shader/x-fragment">
            precision mediump float;

            uniform float u_time;
            varying vec4 fColor;
            varying float fAtlasId;

            uniform sampler2D textureAtlas;  // texture we are drawing
            uniform vec2 textureAtlasSize;  // eg 64x32
            uniform vec2 imageSize;         // eg 16x16

            vec4 clearMix(vec4 pointColor, vec4 color, float level){
                float r = (pointColor.r + color.r) / level;
                float g = (pointColor.g + color.g) / level;
                float b = (pointColor.b + color.b) / level;
                float a = (pointColor.a + color.a);
                return vec4(r, g, b, a);
            }

            void main() {
                vec4 finalColor;

                if(fAtlasId > -1.0){
                    float numColumns = floor(textureAtlasSize.x / imageSize.x); // 128/64 = 1 images horizontal
                    float x = mod(fAtlasId,numColumns);
                    float y = floor(fAtlasId/numColumns);

                    vec2 imageCoord = vec2(x*imageSize.x,y*imageSize.y);
                    vec2 uv = (imageCoord + imageSize * gl_PointCoord) / textureAtlasSize;
                    finalColor = texture2D(textureAtlas, uv);
                }else{
                    finalColor = fColor;
                }
                //finalColor = clearMix(finalColor, vec4(0,0,0, 1), 1.1 );
                gl_FragColor = finalColor;

            }
        </script>
        <script type="text/javascript" src="Common/webgl-utils.js"></script>
        <script type="text/javascript" src="Common/initShaders.js"></script>
        <script type="text/javascript" src="Common/flatten.js"></script>

        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <canvas id="gl-canvas" width="800" height="800">
            Oops ... your browser doesn't support the HTML5 canvas element
        </canvas>

        <script src="stats.js"></script>
        <script src="js/ccapture/CCapture.all.min.js"></script>
        <script src="absulit.module.js" type="module"></script>
        <!-- <script src="js/screen.js" type="module"></script> -->
        <!-- <script src="https://unpkg.com/gpu.js@latest/dist/gpu-browser.min.js"></script> -->
        <script src="main.js" type="module"></script>
        <button id="downloadBtn">START CAPTURE</button>
    </body>
</html>
